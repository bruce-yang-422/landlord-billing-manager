<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»è²»è¨ˆç®—å™¨</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        /* ä½ˆå±€èª¿æ•´ */
        .grid-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .full-row {
            width: 100%;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
        }
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        .calculate-btn {
            background-color: #2ecc71;
            color: white;
            flex: 2;
        }
        .btn-export {
            background-color: #3498db;
            color: white;
            flex: 1;
        }
        .btn-import {
            background-color: #f39c12;
            color: white;
            flex: 1;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
            flex: 0.5;
        }
        .result {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .report-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            min-height: 200px;
            font-size: 14px;
        }
        .copy-btn {
            background-color: #2196F3;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        .copy-btn:hover {
            background-color: #1976D2;
        }
        .usage-display {
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
            margin: 10px 0;
        }
        .total-display {
            font-size: 24px;
            font-weight: bold;
            color: #f44336;
            margin: 15px 0;
        }
        /* æ­·å²ç´€éŒ„è¡¨æ ¼ */
        .history-section {
            margin-top: 40px;
            border-top: 2px dashed #ddd;
            padding-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            color: #666;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .delete-record {
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
            border: none;
            background: none;
            padding: 5px;
            margin-right: 10px;
        }
        .view-record {
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            border: none;
            background: none;
            padding: 5px;
        }
        /* æª”æ¡ˆä¸Šå‚³éš±è— */
        #fileInput {
            display: none;
        }
        /* è²»ç”¨å€å¡Šæ¨£å¼ */
        .fee-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .fee-fields {
            margin-top: 10px;
        }
        .fee-fields input[type="number"] {
            margin-bottom: 10px;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            .grid-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .btn-group {
                flex-direction: column;
            }
            button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ é›»è²»è¨ˆç®—å™¨</h1>
        
        <div class="grid-row">
            <div>
                <label for="billDate">ğŸ“… å¸³å–®æ—¥æœŸ</label>
                <input type="date" id="billDate" value="" placeholder="è«‹é¸æ“‡æ—¥æœŸ">
            </div>
        </div>
        
        <!-- é›»è²»å€å¡Š -->
        <div class="fee-section">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="enableElectricity" checked style="width: auto; margin-right: 10px; cursor: pointer;">
                <label for="enableElectricity" style="margin: 0; font-weight: bold; color: #2c3e50;">âš¡ é›»è²»</label>
            </div>
            <div id="electricityFields" class="fee-fields">
                <div class="grid-row">
                    <div>
                        <label for="pricePerUnit">ğŸ’° é›»è²»å–®åƒ¹ï¼ˆå…ƒ/åº¦ï¼‰</label>
                        <input type="number" id="pricePerUnit" value="" step="0.1" placeholder="è«‹è¼¸å…¥æ¯åº¦é›»è²»">
                    </div>
                </div>
                <div class="grid-row">
                    <div>
                        <label for="lastReading">ğŸ”¢ ä¸ŠæœŸé›»éŒ¶è®€æ•¸</label>
                        <input type="number" id="lastReading" value="" placeholder="è«‹è¼¸å…¥ä¸ŠæœŸè®€æ•¸">
                    </div>
                    <div>
                        <label for="currentReading">ğŸ”¢ æœ¬æœŸé›»éŒ¶è®€æ•¸</label>
                        <input type="number" id="currentReading" value="" placeholder="è«‹è¼¸å…¥æœ¬æœŸè®€æ•¸">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç§Ÿé‡‘å€å¡Š -->
        <div class="fee-section">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="enableRent" checked style="width: auto; margin-right: 10px; cursor: pointer;">
                <label for="enableRent" style="margin: 0; font-weight: bold; color: #2c3e50;">ğŸ  ç§Ÿé‡‘</label>
            </div>
            <div id="rentFields" class="fee-fields">
                <div class="grid-row">
                    <div>
                        <label for="rent">ğŸ  ç§Ÿé‡‘ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="rent" value="" placeholder="è«‹è¼¸å…¥ç§Ÿé‡‘">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ°´è²»ã€ç“¦æ–¯è²» -->
        <div class="grid-row">
            <div class="fee-section">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="enableWater" style="width: auto; margin-right: 10px; cursor: pointer;">
                    <label for="enableWater" style="margin: 0; font-weight: bold; color: #2c3e50;">ğŸ’§ æ°´è²»</label>
                </div>
                <div id="waterFields" class="fee-fields" style="display: none;">
                    <label for="waterFee">ğŸ’§ æ°´è²»ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="waterFee" value="0" placeholder="è«‹è¼¸å…¥æ°´è²»">
                </div>
            </div>
            <div class="fee-section">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="enableGas" style="width: auto; margin-right: 10px; cursor: pointer;">
                    <label for="enableGas" style="margin: 0; font-weight: bold; color: #2c3e50;">ğŸ”¥ ç“¦æ–¯è²»</label>
                </div>
                <div id="gasFields" class="fee-fields" style="display: none;">
                    <label for="gasFee">ğŸ”¥ ç“¦æ–¯è²»ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="gasFee" value="0" placeholder="è«‹è¼¸å…¥ç“¦æ–¯è²»">
                </div>
            </div>
        </div>
        
        <!-- ç®¡ç†è²»ã€å…¶ä»–è²»ç”¨ -->
        <div class="grid-row">
            <div class="fee-section">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="enableManagement" style="width: auto; margin-right: 10px; cursor: pointer;">
                    <label for="enableManagement" style="margin: 0; font-weight: bold; color: #2c3e50;">ğŸ¢ ç®¡ç†è²»</label>
                </div>
                <div id="managementFields" class="fee-fields" style="display: none;">
                    <label for="managementFee">ğŸ¢ ç®¡ç†è²»ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="managementFee" value="0" placeholder="è«‹è¼¸å…¥ç®¡ç†è²»">
                </div>
            </div>
            <div class="fee-section">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="enableOther" style="width: auto; margin-right: 10px; cursor: pointer;">
                    <label for="enableOther" style="margin: 0; font-weight: bold; color: #2c3e50;">ğŸ“ å…¶ä»–è²»ç”¨</label>
                </div>
                <div id="otherFields" class="fee-fields" style="display: none;">
                    <label for="otherFee">ğŸ“ å…¶ä»–è²»ç”¨ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="otherFee" value="0" placeholder="è«‹è¼¸å…¥å…¶ä»–è²»ç”¨">
                </div>
            </div>
        </div>
        
        <div class="full-row" style="background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <label style="color:#2980b9;">ğŸ¦ æ”¶æ¬¾è³‡è¨Š</label>
            <div class="grid-row" style="margin-bottom: 0;">
                <input type="text" id="bankCode" placeholder="éŠ€è¡Œä»£ç¢¼" style="margin-bottom: 5px;">
                <input type="text" id="payeeName" placeholder="æˆ¶å" style="margin-bottom: 5px;">
            </div>
            <input type="text" id="accountNumber" placeholder="éŠ€è¡Œå¸³è™Ÿ">
        </div>
        
        <div class="btn-group">
            <button class="calculate-btn" onclick="calculateAndSave()">ğŸ’¾ è¨ˆç®—ä¸¦å­˜æª”</button>
            <button class="btn-export" onclick="exportData()">ğŸ“¤ å‚™ä»½è³‡æ–™ (JSON)</button>
            <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
            <input type="file" id="fileInput" accept=".json" onchange="importData(this)">
        </div>
        
        <div id="result" class="result" style="display: none;">
            <div id="usageDisplay" class="usage-display" style="display: none;">ç”¨é›»é‡ï¼š<span id="usage"></span> åº¦</div>
            <div id="electricityFeeDisplay" style="display: none;">é›»è²»ï¼š$<span id="electricityFee"></span></div>
            <div id="rentDisplayDiv" style="display: none;">ç§Ÿé‡‘ï¼š$<span id="rentDisplay"></span></div>
            <div id="waterFeeDisplay" style="display: none;">æ°´è²»ï¼š$<span id="waterFeeDisplayAmount"></span></div>
            <div id="gasFeeDisplayDiv" style="display: none;">ç“¦æ–¯è²»ï¼š$<span id="gasFeeDisplay"></span></div>
            <div id="managementFeeDisplay" style="display: none;">ç®¡ç†è²»ï¼š$<span id="managementFeeDisplayAmount"></span></div>
            <div id="otherFeeDisplay" style="display: none;">å…¶ä»–è²»ç”¨ï¼š$<span id="otherFeeDisplayAmount"></span></div>
            <div class="total-display">æœ¬æœŸæ‡‰ä»˜ç¸½é‡‘é¡ï¼š$<span id="totalAmount"></span></div>
        </div>
        
        <div id="reportSection" style="display: none;">
            <h3>ğŸ“‹ LINE å ±è¡¨</h3>
            <div id="reportText" class="report-area"></div>
            <button class="copy-btn" onclick="copyReport()">ğŸ“‹ è¤‡è£½å ±è¡¨</button>
        </div>
        
        <div class="history-section">
            <h3>ğŸ“œ æ­·å²å¸³å–®ç´€éŒ„ 
                <button onclick="clearHistory()" style="float:right; font-size:12px; padding:5px 10px; background:#95a5a6; color:white; border:none; border-radius:4px; cursor:pointer;">æ¸…ç©ºç´€éŒ„</button>
            </h3>
            <div style="overflow-x: auto;">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>ç”¨é›»é‡</th>
                            <th>ç¸½é‡‘é¡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // è³‡æ–™åº«çµæ§‹ï¼š { settings: {}, records: [] }
        let appData = {
            settings: {
                pricePerUnit: 5.5,
                rent: 7000,
                bankCode: '',
                payeeName: '',
                accountNumber: ''
            },
            records: [] // å­˜æ”¾æ­·å²å¸³å–®
        };

        function calculateAndSave() {
            const billDate = document.getElementById('billDate').value;
            const payeeName = document.getElementById('payeeName').value;
            const bankCode = document.getElementById('bankCode').value;
            const accountNumber = document.getElementById('accountNumber').value;
            
            // é©—è­‰
            if (!billDate) {
                alert('è«‹é¸æ“‡å¸³å–®æ—¥æœŸï¼');
                return;
            }
            
            // æª¢æŸ¥å„è²»ç”¨é–‹é—œç‹€æ…‹
            const enableElectricity = document.getElementById('enableElectricity').checked;
            const enableRent = document.getElementById('enableRent').checked;
            const enableWater = document.getElementById('enableWater').checked;
            const enableGas = document.getElementById('enableGas').checked;
            const enableManagement = document.getElementById('enableManagement').checked;
            const enableOther = document.getElementById('enableOther').checked;
            
            // è¨ˆç®—é›»è²»
            let electricityFee = 0;
            let usage = 0;
            let lastReading = 0;
            let currentReading = 0;
            let pricePerUnit = 0;
            
            if (enableElectricity) {
                lastReading = parseFloat(document.getElementById('lastReading').value) || 0;
                currentReading = parseFloat(document.getElementById('currentReading').value) || 0;
                pricePerUnit = parseFloat(document.getElementById('pricePerUnit').value) || 0;
                
                if (currentReading <= lastReading) {
                    alert('æœ¬æœŸé›»éŒ¶è®€æ•¸å¿…é ˆå¤§æ–¼ä¸ŠæœŸè®€æ•¸ï¼');
                    return;
                }
                
                usage = currentReading - lastReading;
                electricityFee = Math.round(usage * pricePerUnit);
            }
            
            // è¨ˆç®—å…¶ä»–è²»ç”¨
            const rent = enableRent ? (parseFloat(document.getElementById('rent').value) || 0) : 0;
            const waterFee = enableWater ? (parseFloat(document.getElementById('waterFee').value) || 0) : 0;
            const gasFee = enableGas ? (parseFloat(document.getElementById('gasFee').value) || 0) : 0;
            const managementFee = enableManagement ? (parseFloat(document.getElementById('managementFee').value) || 0) : 0;
            const otherFee = enableOther ? (parseFloat(document.getElementById('otherFee').value) || 0) : 0;
            
            const totalAmount = electricityFee + rent + waterFee + gasFee + managementFee + otherFee;
            
            // æ›´æ–°è¨­å®š (è¨˜æ†¶ä½¿ç”¨è€…çš„åå¥½)
            appData.settings = {
                pricePerUnit: pricePerUnit,
                rent: rent,
                bankCode: bankCode,
                payeeName: payeeName,
                accountNumber: accountNumber,
                enableElectricity: enableElectricity,
                enableRent: enableRent,
                enableWater: enableWater,
                enableGas: enableGas,
                enableManagement: enableManagement,
                enableOther: enableOther
            };
            
            // æ–°å¢ä¸€ç­†ç´€éŒ„
            const newRecord = {
                id: Date.now(), // å”¯ä¸€è­˜åˆ¥ç¢¼
                date: billDate,
                lastReading: lastReading,
                currentReading: currentReading,
                usage: usage,
                electricityFee: electricityFee,
                rent: rent,
                waterFee: waterFee,
                gasFee: gasFee,
                managementFee: managementFee,
                otherFee: otherFee,
                total: totalAmount,
                pricePerUnit: pricePerUnit,
                enableElectricity: enableElectricity,
                enableRent: enableRent,
                enableWater: enableWater,
                enableGas: enableGas,
                enableManagement: enableManagement,
                enableOther: enableOther
            };
            
            // æŠŠæ–°ç´€éŒ„åŠ åˆ°æœ€å‰é¢
            appData.records.unshift(newRecord);
            
            // å„²å­˜æ‰€æœ‰è¼¸å…¥å€¼åˆ° localStorageï¼ˆå³æ™‚è¨˜æ†¶ï¼‰
            saveAllInputs();
            
            // å„²å­˜æ­·å²è¨˜éŒ„åˆ° localStorage
            saveToLocalStorage();
            
            // é¡¯ç¤ºçµæœ
            displayResult(newRecord);
            
            // æ›´æ–°ä»‹é¢
            renderHistory();
            generateReport(newRecord, appData.settings);
            
            alert('âœ… è¨ˆç®—å®Œæˆä¸¦å·²è‡ªå‹•å­˜æª”ï¼');
        }
        
        // é¡¯ç¤ºè¨ˆç®—çµæœ
        function displayResult(record) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            
            // é¡¯ç¤ºç”¨é›»é‡ï¼ˆåƒ…ç•¶é›»è²»å•Ÿç”¨æ™‚ï¼‰
            if (record.enableElectricity && record.usage > 0) {
                document.getElementById('usageDisplay').style.display = 'block';
                document.getElementById('usage').textContent = record.usage;
                document.getElementById('electricityFeeDisplay').style.display = 'block';
                document.getElementById('electricityFee').textContent = record.electricityFee.toLocaleString();
            } else {
                document.getElementById('usageDisplay').style.display = 'none';
                document.getElementById('electricityFeeDisplay').style.display = 'none';
            }
            
            // é¡¯ç¤ºç§Ÿé‡‘
            if (record.enableRent && record.rent > 0) {
                document.getElementById('rentDisplayDiv').style.display = 'block';
                document.getElementById('rentDisplay').textContent = record.rent.toLocaleString();
            } else {
                document.getElementById('rentDisplayDiv').style.display = 'none';
            }
            
            // é¡¯ç¤ºæ°´è²»
            if (record.enableWater && record.waterFee > 0) {
                document.getElementById('waterFeeDisplay').style.display = 'block';
                document.getElementById('waterFeeDisplayAmount').textContent = record.waterFee.toLocaleString();
            } else {
                document.getElementById('waterFeeDisplay').style.display = 'none';
            }
            
            // é¡¯ç¤ºç“¦æ–¯è²»
            if (record.enableGas && record.gasFee > 0) {
                document.getElementById('gasFeeDisplayDiv').style.display = 'block';
                document.getElementById('gasFeeDisplay').textContent = record.gasFee.toLocaleString();
            } else {
                document.getElementById('gasFeeDisplayDiv').style.display = 'none';
            }
            
            // é¡¯ç¤ºç®¡ç†è²»
            if (record.enableManagement && record.managementFee > 0) {
                document.getElementById('managementFeeDisplay').style.display = 'block';
                document.getElementById('managementFeeDisplayAmount').textContent = record.managementFee.toLocaleString();
            } else {
                document.getElementById('managementFeeDisplay').style.display = 'none';
            }
            
            // é¡¯ç¤ºå…¶ä»–è²»ç”¨
            if (record.enableOther && record.otherFee > 0) {
                document.getElementById('otherFeeDisplay').style.display = 'block';
                document.getElementById('otherFeeDisplayAmount').textContent = record.otherFee.toLocaleString();
            } else {
                document.getElementById('otherFeeDisplay').style.display = 'none';
            }
            
            // é¡¯ç¤ºç¸½é‡‘é¡
            document.getElementById('totalAmount').textContent = record.total.toLocaleString();
        }
        
        function generateReport(record, settings) {
            let dateStr;
            if (record.date) {
                const date = new Date(record.date);
                dateStr = date.getFullYear() + '/' + 
                         String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                         String(date.getDate()).padStart(2, '0');
            } else {
                const now = new Date();
                dateStr = now.getFullYear() + '/' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                         String(now.getDate()).padStart(2, '0');
            }
            
            let report = `ğŸ“… ${dateStr} æˆ¿ç§Ÿè²»ç”¨é€šçŸ¥\n\n`;
            
            // é›»è²»è¨ˆç®—éƒ¨åˆ†
            if (record.enableElectricity && record.usage > 0) {
                report += `âš¡ é›»è²»è¨ˆç®—\n`;
                report += `${record.currentReading} (æœ¬æœŸ) - ${record.lastReading} (ä¸ŠæœŸ) \n`;
                report += `= ${record.usage} åº¦\n`;
                report += `${record.usage} åº¦ Ã— ${record.pricePerUnit} = $${record.electricityFee}\n\n`;
            }
            
            // æ‡‰ç¹³é‡‘é¡éƒ¨åˆ†
            report += `ğŸ’° æ‡‰ç¹³é‡‘é¡\n`;
            if (record.enableElectricity && record.electricityFee > 0) {
                report += `é›»è²»ï¼š$${record.electricityFee.toLocaleString()}\n`;
            }
            if (record.enableRent && record.rent > 0) {
                report += `æˆ¿ç§Ÿï¼š$${record.rent.toLocaleString()}\n`;
            }
            if (record.enableWater && record.waterFee > 0) {
                report += `æ°´è²»ï¼š$${record.waterFee.toLocaleString()}\n`;
            }
            if (record.enableGas && record.gasFee > 0) {
                report += `ç“¦æ–¯ï¼š$${record.gasFee.toLocaleString()}\n`;
            }
            if (record.enableManagement && record.managementFee > 0) {
                report += `ç®¡ç†è²»ï¼š$${record.managementFee.toLocaleString()}\n`;
            }
            if (record.enableOther && record.otherFee > 0) {
                report += `å…¶ä»–è²»ç”¨ï¼š$${record.otherFee.toLocaleString()}\n`;
            }
            report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            report += `ç¸½è¨ˆï¼š$${record.total.toLocaleString()}\n\n`;
            
            // åŒ¯æ¬¾è³‡è¨Š
            if (settings.bankCode && settings.accountNumber) {
                report += `ğŸ¦ åŒ¯æ¬¾è³‡è¨Š\n`;
                report += `(${settings.bankCode}) ${settings.accountNumber}\n`;
                report += `æˆ¶åï¼š${settings.payeeName}\n\n`;
            }
            
            // è¨ˆç®—éç¨‹
            report += `è¨ˆç®—éç¨‹ï¼š\n`;
            const feeParts = [];
            if (record.enableElectricity && record.usage > 0) {
                report += `${record.currentReading} - ${record.lastReading} = ${record.usage} åº¦\n`;
                report += `${record.usage} Ã— ${record.pricePerUnit} = ${record.electricityFee}\n`;
                feeParts.push(record.electricityFee);
            }
            if (record.enableRent && record.rent > 0) {
                feeParts.push(record.rent);
            }
            if (record.enableWater && record.waterFee > 0) {
                feeParts.push(record.waterFee);
            }
            if (record.enableGas && record.gasFee > 0) {
                feeParts.push(record.gasFee);
            }
            if (record.enableManagement && record.managementFee > 0) {
                feeParts.push(record.managementFee);
            }
            if (record.enableOther && record.otherFee > 0) {
                feeParts.push(record.otherFee);
            }
            if (feeParts.length > 0) {
                report += feeParts.join(' + ') + ` = ${record.total}`;
            }
            
            document.getElementById('reportText').textContent = report;
            document.getElementById('reportSection').style.display = 'block';
        }
        
        // è‡ªå‹•å¡«å…¥ä¸ŠæœŸè®€æ•¸ (æ‰¾æœ€è¿‘çš„ä¸€ç­†ç´€éŒ„)
        function autoFillLastReading() {
            if (appData.records.length > 0) {
                // å–æœ€è¿‘ä¸€æ¬¡çš„ã€Œæœ¬æœŸã€ä½œç‚ºé€™æ¬¡çš„ã€Œä¸ŠæœŸã€
                document.getElementById('lastReading').value = appData.records[0].currentReading;
            }
        }
        
        // æ¸²æŸ“æ­·å²åˆ—è¡¨
        function renderHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            
            if (appData.records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">å°šç„¡æ­·å²ç´€éŒ„</td></tr>';
                return;
            }
            
            appData.records.forEach(record => {
                const tr = document.createElement('tr');
                const date = new Date(record.date);
                const dateStr = date.getFullYear() + '/' + 
                              String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                              String(date.getDate()).padStart(2, '0');
                
                const usageText = (record.enableElectricity && record.usage > 0) ? `${record.usage} åº¦` : '-';
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${usageText}</td>
                    <td style="color:#e74c3c; font-weight:bold;">$${record.total.toLocaleString()}</td>
                    <td>
                        <button class="delete-record" onclick="deleteRecord(${record.id})">åˆªé™¤</button>
                        <button class="view-record" onclick="loadRecord(${record.id})">æŸ¥çœ‹</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // åˆªé™¤å–®ç­†ç´€éŒ„
        function deleteRecord(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                appData.records = appData.records.filter(r => r.id !== id);
                saveToLocalStorage();
                renderHistory();
            }
        }
        
        // æŸ¥çœ‹/è¼‰å…¥èˆŠç´€éŒ„åˆ°å ±è¡¨å€
        function loadRecord(id) {
            const record = appData.records.find(r => r.id === id);
            if(record) {
                generateReport(record, appData.settings);
                document.getElementById('reportSection').scrollIntoView({behavior: 'smooth'});
            }
        }
        
        // æ¸…ç©ºæ­·å²è¨˜éŒ„
        function clearHistory() {
            if(confirm('è­¦å‘Šï¼šé€™å°‡æ¸…ç©ºæ‰€æœ‰æ­·å²å¸³å–®ç´€éŒ„ï¼å»ºè­°å…ˆå‚™ä»½ JSONã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                appData.records = [];
                saveToLocalStorage();
                renderHistory();
            }
        }
        
        // --- è³‡æ–™å­˜å–æ ¸å¿ƒ ---
        function saveToLocalStorage() {
            try {
                localStorage.setItem('electricityCalculator_db', JSON.stringify(appData));
            } catch (e) {
                console.error('å„²å­˜å¤±æ•—:', e);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const json = localStorage.getItem('electricityCalculator_db');
                if (json) {
                    appData = JSON.parse(json);
                    
                    // é‚„åŸè¨­å®šå€¼åˆ° UI
                    if (appData.settings.pricePerUnit) {
                        document.getElementById('pricePerUnit').value = appData.settings.pricePerUnit;
                    }
                    if (appData.settings.rent) {
                        document.getElementById('rent').value = appData.settings.rent;
                    }
                    if (appData.settings.bankCode) {
                        document.getElementById('bankCode').value = appData.settings.bankCode;
                    }
                    if (appData.settings.payeeName) {
                        document.getElementById('payeeName').value = appData.settings.payeeName;
                    }
                    if (appData.settings.accountNumber) {
                        document.getElementById('accountNumber').value = appData.settings.accountNumber;
                    }
                    
                    // è¼‰å…¥é–‹é—œç‹€æ…‹
                    if (appData.settings.enableElectricity !== undefined) {
                        document.getElementById('enableElectricity').checked = appData.settings.enableElectricity;
                    }
                    if (appData.settings.enableRent !== undefined) {
                        document.getElementById('enableRent').checked = appData.settings.enableRent;
                    }
                    if (appData.settings.enableWater !== undefined) {
                        document.getElementById('enableWater').checked = appData.settings.enableWater;
                    }
                    if (appData.settings.enableGas !== undefined) {
                        document.getElementById('enableGas').checked = appData.settings.enableGas;
                    }
                    if (appData.settings.enableManagement !== undefined) {
                        document.getElementById('enableManagement').checked = appData.settings.enableManagement;
                    }
                    if (appData.settings.enableOther !== undefined) {
                        document.getElementById('enableOther').checked = appData.settings.enableOther;
                    }
                    
                    renderHistory();
                }
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—:', e);
            }
        }
        
        // åŒ¯å‡º JSON (å‚™ä»½)
        function exportData() {
            try {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                // ä½¿ç”¨å›ºå®šæª”åï¼Œæ¯æ¬¡åŒ¯å‡ºéƒ½æœƒè¦†è“‹åŒä¸€å€‹æª”æ¡ˆï¼Œé¿å…ç´¯ç©
                downloadAnchorNode.setAttribute("download", "billing-records-backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                alert('âœ… è³‡æ–™å·²åŒ¯å‡ºï¼(æª”åï¼šbilling-records-backup.jsonï¼Œå·²è¦†è“‹èˆŠæª”æ¡ˆ)');
            } catch (e) {
                alert('âŒ åŒ¯å‡ºå¤±æ•—ï¼š' + e.message);
            }
        }
        
        // åŒ¯å…¥ JSON (é‚„åŸ)
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // ç°¡å–®æ ¼å¼æª¢æŸ¥
                    if (importedData.records && Array.isArray(importedData.records)) {
                        appData = importedData;
                        saveToLocalStorage();
                        loadFromLocalStorage(); // åˆ·æ–°ä»‹é¢
                        autoFillLastReading();
                        alert('âœ… è³‡æ–™åŒ¯å…¥æˆåŠŸï¼æ­·å²ç´€éŒ„å·²é‚„åŸã€‚');
                    } else {
                        alert('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªé€™æ˜¯æœ¬å·¥å…·åŒ¯å‡ºçš„ JSON æª”');
                    }
                } catch (error) {
                    alert('âŒ è®€å–å¤±æ•—ï¼š' + error);
                }
            };
            reader.readAsText(file);
            // æ¸…ç©º input è®“åŒå€‹æª”æ¡ˆå¯ä»¥å†æ¬¡è§¸ç™¼ change
            input.value = '';
        }
        
        function copyReport() {
            const reportText = document.getElementById('reportText').textContent;
            
            // ä½¿ç”¨ç¾ä»£çš„ Clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(reportText).then(() => {
                    alert('âœ… å ±è¡¨å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼å¯ä»¥è²¼åˆ°LINEå›‰ï¼');
                }).catch(err => {
                    console.error('è¤‡è£½å¤±æ•—: ', err);
                    fallbackCopyTextToClipboard(reportText);
                });
            } else {
                fallbackCopyTextToClipboard(reportText);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-999px";
            textArea.style.left = "-999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('âœ… å ±è¡¨å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼å¯ä»¥è²¼åˆ°LINEå›‰ï¼');
            } catch (err) {
                alert('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½');
            }
            
            document.body.removeChild(textArea);
        }
        
        // å„²å­˜æ‰€æœ‰è¼¸å…¥å€¼åˆ° localStorage
        function saveAllInputs() {
            try {
                const inputs = {
                    lastReading: document.getElementById('lastReading').value,
                    currentReading: document.getElementById('currentReading').value,
                    pricePerUnit: document.getElementById('pricePerUnit').value,
                    rent: document.getElementById('rent').value,
                    waterFee: document.getElementById('waterFee').value,
                    gasFee: document.getElementById('gasFee').value,
                    managementFee: document.getElementById('managementFee').value,
                    otherFee: document.getElementById('otherFee').value,
                    billDate: document.getElementById('billDate').value,
                    payeeName: document.getElementById('payeeName').value,
                    bankCode: document.getElementById('bankCode').value,
                    accountNumber: document.getElementById('accountNumber').value,
                    enableElectricity: document.getElementById('enableElectricity').checked,
                    enableRent: document.getElementById('enableRent').checked,
                    enableWater: document.getElementById('enableWater').checked,
                    enableGas: document.getElementById('enableGas').checked,
                    enableManagement: document.getElementById('enableManagement').checked,
                    enableOther: document.getElementById('enableOther').checked
                };
                localStorage.setItem('electricityCalculator_inputs', JSON.stringify(inputs));
            } catch (e) {
                console.error('å„²å­˜å¤±æ•—:', e);
            }
        }
        
        // è¼‰å…¥æ‰€æœ‰è¼¸å…¥å€¼
        function loadAllInputs() {
            try {
                const saved = localStorage.getItem('electricityCalculator_inputs');
                if (saved) {
                    const inputs = JSON.parse(saved);
                    
                    if (inputs.lastReading) document.getElementById('lastReading').value = inputs.lastReading;
                    if (inputs.currentReading) document.getElementById('currentReading').value = inputs.currentReading;
                    if (inputs.pricePerUnit) document.getElementById('pricePerUnit').value = inputs.pricePerUnit;
                    if (inputs.rent) document.getElementById('rent').value = inputs.rent;
                    if (inputs.waterFee !== undefined) document.getElementById('waterFee').value = inputs.waterFee;
                    if (inputs.gasFee !== undefined) document.getElementById('gasFee').value = inputs.gasFee;
                    if (inputs.managementFee !== undefined) document.getElementById('managementFee').value = inputs.managementFee;
                    if (inputs.otherFee !== undefined) document.getElementById('otherFee').value = inputs.otherFee;
                    if (inputs.billDate) document.getElementById('billDate').value = inputs.billDate;
                    if (inputs.payeeName) document.getElementById('payeeName').value = inputs.payeeName;
                    if (inputs.bankCode) document.getElementById('bankCode').value = inputs.bankCode;
                    if (inputs.accountNumber) document.getElementById('accountNumber').value = inputs.accountNumber;
                    
                    // è¼‰å…¥é–‹é—œç‹€æ…‹
                    if (inputs.enableElectricity !== undefined) document.getElementById('enableElectricity').checked = inputs.enableElectricity;
                    if (inputs.enableRent !== undefined) document.getElementById('enableRent').checked = inputs.enableRent;
                    if (inputs.enableWater !== undefined) document.getElementById('enableWater').checked = inputs.enableWater;
                    if (inputs.enableGas !== undefined) document.getElementById('enableGas').checked = inputs.enableGas;
                    if (inputs.enableManagement !== undefined) document.getElementById('enableManagement').checked = inputs.enableManagement;
                    if (inputs.enableOther !== undefined) document.getElementById('enableOther').checked = inputs.enableOther;
                }
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—:', e);
            }
        }
        
        // ç‚ºæ‰€æœ‰è¼¸å…¥æ¬„ä½æ·»åŠ è‡ªå‹•å„²å­˜åŠŸèƒ½
        function setupAutoSave() {
            const inputIds = ['lastReading', 'currentReading', 'pricePerUnit', 'rent', 'gasFee', 'waterFee', 'managementFee', 'otherFee', 'billDate', 'payeeName', 'bankCode', 'accountNumber'];
            
            inputIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function() {
                        saveAllInputs();
                    });
                    input.addEventListener('change', function() {
                        saveAllInputs();
                    });
                }
            });
        }
        
        // è²»ç”¨é–‹é—œåˆ‡æ›åŠŸèƒ½
        function setupFeeToggles() {
            const toggles = [
                { checkbox: 'enableElectricity', fields: 'electricityFields' },
                { checkbox: 'enableRent', fields: 'rentFields' },
                { checkbox: 'enableWater', fields: 'waterFields' },
                { checkbox: 'enableGas', fields: 'gasFields' },
                { checkbox: 'enableManagement', fields: 'managementFields' },
                { checkbox: 'enableOther', fields: 'otherFields' }
            ];
            
            toggles.forEach(toggle => {
                const checkbox = document.getElementById(toggle.checkbox);
                const fields = document.getElementById(toggle.fields);
                if (checkbox && fields) {
                    checkbox.addEventListener('change', function() {
                        fields.style.display = this.checked ? 'block' : 'none';
                        saveAllInputs();
                    });
                    // åˆå§‹åŒ–é¡¯ç¤ºç‹€æ…‹
                    fields.style.display = checkbox.checked ? 'block' : 'none';
                }
            });
        }
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            
            // å…ˆè¼‰å…¥æ­·å²è¨˜éŒ„è³‡æ–™åº«
            loadFromLocalStorage();
            
            // è¼‰å…¥å„²å­˜çš„è¼¸å…¥å€¼ï¼ˆå³æ™‚è¨˜æ†¶ï¼‰
            loadAllInputs();
            
            // å¦‚æœæ²’æœ‰å„²å­˜çš„æ—¥æœŸï¼Œè¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
            if (!document.getElementById('billDate').value) {
                document.getElementById('billDate').value = todayStr;
            }
            
            // æ ¹æ“šæ­·å²ç´€éŒ„è‡ªå‹•å¡«å…¥ã€Œä¸ŠæœŸè®€æ•¸ã€
            autoFillLastReading();
            
            // è¨­å®šè²»ç”¨é–‹é—œåŠŸèƒ½
            setupFeeToggles();
            
            // è¨­å®šè‡ªå‹•å„²å­˜åŠŸèƒ½
            setupAutoSave();
        };
        
        // æŒ‰Enteréµæ™‚è¨ˆç®—
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateAndSave();
            }
        });
    </script>
</body>
</html>